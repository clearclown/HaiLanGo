# 機能実装: 教師モード（自動学習モード）

## 要件

### 機能要件

#### 教師モード機能
1. **自動連続再生**
   - 全ページを自動で順次進行
   - 各ページで音声読み上げ + 解説
   - 設定した間隔で次のページへ自動遷移

2. **カスタマイズ設定**
   - **再生速度**: 0.5x, 0.75x, 1.0x, 1.25x, 1.5x, 2.0x
   - **ページ間隔**: 0秒〜30秒
   - **リピート回数**: 1〜3回
   - **学習内容**:
     - ✓ 学習先言語の読み上げ（必須）
     - ✓ 母国語訳の読み上げ（オプション）
     - ✓ 単語解説（オプション）
     - ✓ 文法解説（オプション）
     - ✓ 発音練習タイム（オプション）

3. **バックグラウンド再生**
   - 画面オフでも再生継続
   - ロック画面からのコントロール
   - 通知センターでの操作

4. **オフライン対応**
   - 音声データの事前一括ダウンロード
   - Wi-Fi接続時のみダウンロード推奨
   - ダウンロード管理画面

#### ユーザー操作
- 一時停止・再開
- 前のページへ・次のページへ
- 停止（通常モードへ戻る）
- 設定変更（その場で反映）

### 非機能要件

- **パフォーマンス**:
  - 音声生成: 事前生成推奨
  - ページ遷移: スムーズ（60fps）
  - バックグラウンド再生: 安定性重視

- **セキュリティ**:
  - ユーザー認証必須
   - オフライン音声データの暗号化

- **拡張性**:
  - 将来的な学習内容追加への対応
  - カスタム設定プリセット

- **エラーハンドリング**:
  - ネットワーク切断時の処理
  - 音声再生エラーの処理
  - オフラインモードへの自動切り替え

## 実装指示

### Step 1: テスト設計

以下の順でテストを作成：

1. **ユニットテスト（関数/メソッドレベル）**
   - ページ遷移ロジック
   - タイマー制御
   - 音声再生制御
   - 設定の保存・読み込み

2. **統合テスト（モジュール間）**
   - 教師モードの開始〜終了
   - バックグラウンド再生
   - オフライン再生
   - 設定変更の反映

3. **エッジケースのテスト**
   - 最初のページ
   - 最後のページ
   - ネットワーク切断時
   - 音声再生エラー
   - バックグラウンドからの復帰

テストファイルは以下の場所に配置：
- **フロントエンド**: `frontend/web/components/teacher-mode/*.test.tsx` (Vitest単体・統合テスト)
- **フロントエンドE2E**: `frontend/web/e2e/teacher-mode.spec.ts` (Playwright E2Eテスト)
- **バックエンド**: `backend/internal/api/teacher-mode/` (Goテスト)

テストは **実装前に実行してすべて失敗すること** を確認。

#### テスト例（Vitest - 単体・統合テスト）

```typescript
// frontend/web/components/teacher-mode/TeacherMode.test.tsx
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { TeacherMode } from './TeacherMode';

describe('TeacherMode', () => {
  beforeEach(() => {
    vi.useFakeTimers();
  });

  afterEach(() => {
    vi.useRealTimers();
  });

  it('should start teacher mode', async () => {
    render(<TeacherMode bookId="test-book" />);
    fireEvent.click(screen.getByText('開始'));
    await waitFor(() => {
      expect(screen.getByText('再生中')).toBeInTheDocument();
    });
  });

  it('should pause and resume', async () => {
    const { getByText } = render(<TeacherMode bookId="test-book" />);
    fireEvent.click(getByText('一時停止'));
    await waitFor(() => {
      expect(screen.getByText('一時停止中')).toBeInTheDocument();
    });
    fireEvent.click(getByText('再開'));
    await waitFor(() => {
      expect(screen.getByText('再生中')).toBeInTheDocument();
    });
  });

  it('should navigate to next page automatically', async () => {
    render(<TeacherMode bookId="test-book" pageInterval={1000} />);
    fireEvent.click(screen.getByText('開始'));
    vi.advanceTimersByTime(1000);
    await waitFor(() => {
      expect(screen.getByText('ページ 2')).toBeInTheDocument();
    });
  });

  it('should handle background playback', () => {
    // Media Session APIのモック
    const mockMediaSession = {
      metadata: null,
      setActionHandler: vi.fn(),
    };
    global.navigator.mediaSession = mockMediaSession as any;

    render(<TeacherMode bookId="test-book" />);
    expect(mockMediaSession.setActionHandler).toHaveBeenCalled();
  });
});
```

#### テスト例（Playwright - E2Eテスト）

```typescript
// frontend/web/e2e/teacher-mode.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Teacher Mode', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/login');
    await page.fill('[name="email"]', 'test@example.com');
    await page.fill('[name="password"]', 'password');
    await page.click('button[type="submit"]');
  });

  test('should start teacher mode', async ({ page }) => {
    await page.goto('/books/test-book/teacher-mode');
    await page.click('text=開始');
    await expect(page.locator('text=再生中')).toBeVisible();
  });

  test('should pause and resume', async ({ page }) => {
    await page.goto('/books/test-book/teacher-mode');
    await page.click('text=開始');
    await page.click('text=一時停止');
    await expect(page.locator('text=一時停止中')).toBeVisible();
    await page.click('text=再開');
    await expect(page.locator('text=再生中')).toBeVisible();
  });
});
```

#### テスト例（Go）

```go
// backend/internal/service/teacher-mode/service_test.go
package teachermode

import (
    "testing"
    "context"
    "github.com/stretchr/testify/assert"
)

func TestGeneratePlaylist(t *testing.T) {
    ctx := context.Background()
    settings := &TeacherModeSettings{
        Speed: 1.0,
        PageInterval: 5,
        IncludeTranslation: true,
    }

    playlist, err := GeneratePlaylist(ctx, "test-book", settings)
    assert.NoError(t, err)
    assert.NotEmpty(t, playlist.Pages)
}

func TestGenerateAudioSegments(t *testing.T) {
    // 音声セグメント生成のテスト
    // ...
}
```

### Step 2: 実装

- テストが通るように実装
- コードコメントは日本語で
- 型安全性を最優先
- エラーハンドリングを必ず含める

#### 実装ファイル構造

```
frontend/web/
├── components/
│   └── teacher-mode/
│       ├── TeacherMode.tsx         # メインコンポーネント
│       ├── TeacherModeSettings.tsx # 設定画面
│       ├── AudioPlaylist.tsx       # 音声プレイリスト
│       ├── BackgroundPlayer.tsx    # バックグラウンド再生
│       └── TeacherMode.test.tsx
├── hooks/
│   ├── useTeacherMode.ts           # 教師モードロジック
│   └── useBackgroundAudio.ts       # バックグラウンド音声
└── services/
    └── teacherModeApi.ts           # API呼び出し

backend/
├── internal/
│   ├── api/
│   │   └── teacher-mode/
│   │       ├── handler.go           # HTTPハンドラー
│   │       └── handler_test.go
│   └── service/
│       └── teacher-mode/
│           ├── service.go           # 教師モードサービス
│           ├── playlist.go          # プレイリスト生成
│           └── service_test.go
```

#### 主要な実装ポイント

1. **教師モードコンポーネント**
   ```typescript
   // frontend/web/components/teacher-mode/TeacherMode.tsx
   export const TeacherMode: React.FC<Props> = ({ bookId }) => {
     const { playlist, loading } = useTeacherModePlaylist(bookId);
     const { play, pause, next, previous } = useBackgroundAudio();
     const { settings, updateSettings } = useTeacherModeSettings();

     // 自動再生制御
     // ページ遷移制御
     // バックグラウンド再生
   };
   ```

2. **プレイリスト生成**
   ```go
   // backend/internal/service/teacher-mode/playlist.go
   func GeneratePlaylist(ctx context.Context, bookID string, settings *TeacherModeSettings) (*TeacherModePlaylist, error) {
       // 1. 全ページ取得
       // 2. 各ページの音声セグメント生成
       // 3. TTS API呼び出し（キャッシュ優先）
       // 4. プレイリスト構築
   }
   ```

3. **バックグラウンド再生（Web）**
   ```typescript
   // frontend/web/hooks/useBackgroundAudio.ts
   export const useBackgroundAudio = () => {
     useEffect(() => {
       // Media Session API設定
       navigator.mediaSession.metadata = new MediaMetadata({
         title: '教師モード',
       });

       navigator.mediaSession.setActionHandler('play', play);
       navigator.mediaSession.setActionHandler('pause', pause);
     }, []);
   };
   ```

### Step 3: リファクタリング

- DRY原則の適用
- パフォーマンス最適化（音声のプリロード）
- コードの可読性向上

### Step 4: ドキュメント

- README.md への機能説明追加
- APIドキュメント
- 教師モードの使用方法ガイド

#### APIエンドポイント

```
POST /api/v1/books/{book_id}/teacher-mode/generate
GET  /api/v1/books/{book_id}/teacher-mode/playlist
POST /api/v1/books/{book_id}/teacher-mode/download-package
PUT  /api/v1/books/{book_id}/teacher-mode/playback-state
```

## 制約事項

- 既存の `frontend/web/components/learning/` は変更しない
- `frontend/web/components/teacher-mode/` 配下のみ編集可能
- 依存関係の追加は `package.json` のみ

## 完了条件

- [ ] すべてのテストが通る（Vitest + Playwright）
- [ ] BiomeJSエラーがない
- [ ] タイプエラーがない
- [ ] GitHub CIが通る
- [ ] ドキュメントが更新されている
- [ ] バックグラウンド再生の動作確認
- [ ] オフライン再生の動作確認

## 追加のテスト要件

### セキュリティテスト
- [ ] ユーザー認証の動作確認
- [ ] オフライン音声データの暗号化

### パフォーマンステスト
- [ ] 連続再生の安定性（1時間以上）
- [ ] メモリリーク検証
- [ ] バッテリー消費量（モバイル）

### E2Eテスト
- [ ] 教師モードの開始〜終了
- [ ] バックグラウンド再生の動作確認
- [ ] オフライン再生の動作確認
