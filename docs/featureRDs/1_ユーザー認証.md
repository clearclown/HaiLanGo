# 機能実装: ユーザー認証

## 要件

### 機能要件

#### 認証方式
1. **OAuth 2.0認証**
   - Google Login対応
   - 認証成功後、JWTトークンを発行
   - ユーザー情報を取得してアカウント作成/ログイン

2. **Email/Password認証**
   - メールアドレスとパスワードでの登録
   - パスワード要件：
     - 最小8文字
     - 大文字・小文字・数字・記号のうち3種類以上を含む
   - メール認証（認証リンク送信）
   - パスワードリセット機能

#### セッション管理
- JWT（JSON Web Token）を使用
- アクセストークン：有効期限15分
- リフレッシュトークン：有効期限7日
- Redisでリフレッシュトークンを管理

#### ユーザー情報管理
- ユーザーID（UUID）
- メールアドレス
- 表示名
- プロフィール画像（OAuthから取得）
- 作成日時・更新日時
- メール認証状態

### 非機能要件

- **パフォーマンス**:
  - 認証処理: 500ms以内
  - JWT検証: 10ms以内
  - 同時接続数: 1000ユーザー以上

- **セキュリティ**:
  - パスワードはbcryptでハッシュ化（コスト10）
  - HTTPS必須
  - CSRF対策（SameSite Cookie）
  - レート制限：ログイン試行5回/15分
  - セキュアなJWT署名（RS256推奨）

- **拡張性**:
  - 将来的にGitHub、Apple、Facebook認証を追加可能な設計
  - 多要素認証（MFA）対応の拡張性

- **エラーハンドリング**:
  - 認証失敗時は具体的なエラーメッセージを返却
  - ログに認証試行を記録（セキュリティ監査用）
  - ユーザーに分かりやすいエラーメッセージ

## 実装指示

### Step 1: テスト設計

以下の順でテストを作成：

1. **ユニットテスト（関数/メソッドレベル）**
   - パスワードハッシュ化・検証関数
   - JWT生成・検証関数
   - メールアドレスバリデーション
   - パスワード強度チェック

2. **統合テスト（モジュール間）**
   - OAuth認証フロー（モック）
   - Email/Password認証フロー
   - JWTトークンリフレッシュ
   - パスワードリセットフロー

3. **エッジケースのテスト**
   - 無効なトークン
   - 期限切れトークン
   - 重複メールアドレス
   - SQLインジェクション対策
   - XSS対策

テストファイルは `backend/internal/api/auth/auth_test.go` および `backend/internal/service/auth_test.go` に配置。

テストは **実装前に実行してすべて失敗すること** を確認。

#### テスト例（Go）

```go
// backend/internal/service/auth_test.go
package service

import (
    "testing"
    "time"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
)

func TestHashPassword(t *testing.T) {
    password := "TestPassword123!"
    hash, err := HashPassword(password)
    require.NoError(t, err)
    assert.NotEmpty(t, hash)
    assert.NotEqual(t, password, hash)
}

func TestVerifyPassword(t *testing.T) {
    password := "TestPassword123!"
    hash, _ := HashPassword(password)

    // 正しいパスワード
    assert.True(t, VerifyPassword(password, hash))

    // 間違ったパスワード
    assert.False(t, VerifyPassword("WrongPassword", hash))
}

func TestGenerateJWT(t *testing.T) {
    userID := "test-user-id"
    token, err := GenerateJWT(userID)
    require.NoError(t, err)
    assert.NotEmpty(t, token)

    // トークンの検証
    claims, err := VerifyJWT(token)
    require.NoError(t, err)
    assert.Equal(t, userID, claims.UserID)
}

func TestOAuthLogin(t *testing.T) {
    // OAuth認証のモックテスト
    // ...
}
```

### Step 2: 実装

- テストが通るように実装
- コードコメントは日本語で
- 型安全性を最優先
- エラーハンドリングを必ず含める

#### 実装ファイル構造

```
backend/
├── internal/
│   ├── api/
│   │   └── auth/
│   │       ├── handler.go          # HTTPハンドラー
│   │       └── handler_test.go
│   ├── service/
│   │   ├── auth.go                 # 認証ビジネスロジック
│   │   └── auth_test.go
│   ├── repository/
│   │   ├── user.go                 # ユーザーDB操作
│   │   └── user_test.go
│   └── models/
│       └── user.go                 # ユーザーモデル
├── pkg/
│   ├── jwt/
│   │   ├── jwt.go                  # JWT生成・検証
│   │   └── jwt_test.go
│   └── password/
│       ├── password.go             # パスワードハッシュ化
│       └── password_test.go
```

#### 主要な実装ポイント

1. **パスワードハッシュ化**
   ```go
   // pkg/password/password.go
   func HashPassword(password string) (string, error) {
       // bcryptでハッシュ化（コスト10）
   }

   func VerifyPassword(password, hash string) bool {
       // bcryptで検証
   }
   ```

2. **JWT生成・検証**
   ```go
   // pkg/jwt/jwt.go
   func GenerateToken(userID string) (string, error) {
       // JWT生成（RS256）
   }

   func VerifyToken(tokenString string) (*Claims, error) {
       // JWT検証
   }
   ```

3. **OAuth認証**
   ```go
   // internal/service/auth.go
   func (s *AuthService) OAuthLogin(provider string, code string) (*User, string, error) {
       // OAuth認証処理
       // 1. 認証コードでアクセストークン取得
       // 2. ユーザー情報取得
       // 3. ユーザー作成/更新
       // 4. JWT発行
   }
   ```

### Step 3: リファクタリング

- DRY原則の適用
- パフォーマンス最適化
- コードの可読性向上

### Step 4: ドキュメント

- README.md への機能説明追加
- APIドキュメント（該当する場合）
- 使用例

#### APIエンドポイント

```
POST /api/v1/auth/register
POST /api/v1/auth/login
POST /api/v1/auth/oauth/google
POST /api/v1/auth/refresh
POST /api/v1/auth/reset-password
POST /api/v1/auth/verify-email
```

## 制約事項

- 既存の `backend/internal/models/` は変更しない（新規追加のみ）
- `backend/internal/api/auth/` 配下のみ編集可能
- 依存関係の追加は `go.mod` のみ

## 完了条件

- [ ] すべてのテストが通る
- [ ] lintエラーがない（golangci-lint）
- [ ] タイプエラーがない
- [ ] ドキュメントが更新されている
- [ ] セキュリティチェック（OWASP Top 10対応）
- [ ] パフォーマンステスト（500ms以内）

## 追加のテスト要件

### セキュリティテスト
- [ ] SQLインジェクション対策
- [ ] XSS対策
- [ ] CSRF対策
- [ ] レート制限の動作確認
- [ ] パスワード強度チェック

### パフォーマンステスト
- [ ] 認証処理のレスポンスタイム（500ms以内）
- [ ] 同時接続テスト（1000ユーザー）
- [ ] JWT検証のオーバーヘッド測定

### E2Eテスト
- [ ] ブラウザでのOAuth認証フロー
- [ ] Email/Password認証フロー
- [ ] パスワードリセットフロー
