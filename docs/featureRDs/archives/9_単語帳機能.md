# 機能実装: 単語帳機能

## 要件

### 機能要件

#### 単語帳機能
1. **自動単語収集**
   - 学習中のページから単語を自動抽出
   - OCR結果から単語を抽出
   - ユーザーによる手動追加

2. **単語情報**
   - 単語（学習先言語）
   - 意味（母国語）
   - 発音記号（オプション）
   - 例文（オプション）
   - 品詞
   - 学習回数
   - 習得度（0-100%）

3. **単語帳管理**
   - 単語の追加・編集・削除
   - 単語の検索・フィルタリング
   - 単語のグループ化（タグ）
   - 単語のエクスポート（CSV/JSON）

4. **学習機能**
   - 単語カード表示
   - フラッシュカード学習
   - 発音練習
   - クイズ形式の学習

### 非機能要件

- **パフォーマンス**:
  - 単語検索: 100ms以内
  - 単語帳表示: 500ms以内
  - 大量単語（1000語以上）への対応

- **セキュリティ**:
  - ユーザー認証必須
  - 単語データのプライバシー保護

- **拡張性**:
  - 将来的な辞書API統合への対応
  - カスタム単語帳の作成

- **エラーハンドリング**:
  - 重複単語の検出
  - データ不整合の処理
  - ユーザーフレンドリーなエラーメッセージ

## 実装指示

### Step 1: テスト設計

以下の順でテストを作成：

1. **ユニットテスト（関数/メソッドレベル）**
   - 単語抽出ロジック
   - 単語検索
   - 単語フィルタリング
   - 習得度計算

2. **統合テスト（モジュール間）**
   - 単語の自動収集
   - 単語帳の表示
   - 単語の追加・編集・削除
   - 学習機能

3. **エッジケースのテスト**
   - 重複単語
   - 空の単語帳
   - 大量単語（1000語以上）
   - 特殊文字を含む単語

テストファイルは `backend/internal/service/vocabulary/vocabulary_test.go` に配置。

テストは **実装前に実行してすべて失敗すること** を確認。

#### テスト例（Go）

```go
// backend/internal/service/vocabulary/vocabulary_test.go
package vocabulary

import (
    "testing"
    "context"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
)

func TestExtractWords(t *testing.T) {
    text := "Здравствуйте! Как дела?"
    words := ExtractWords(text, "ru")

    assert.Contains(t, words, "Здравствуйте")
    assert.Contains(t, words, "Как")
    assert.Contains(t, words, "дела")
}

func TestAddWord(t *testing.T) {
    ctx := context.Background()
    userID := "test-user"
    word := &Word{
        Text: "Здравствуйте",
        Meaning: "こんにちは",
        Language: "ru",
    }

    err := AddWord(ctx, userID, word)
    require.NoError(t, err)

    // 重複追加のテスト
    err = AddWord(ctx, userID, word)
    assert.Error(t, err) // 重複エラー
}

func TestSearchWords(t *testing.T) {
    ctx := context.Background()
    userID := "test-user"
    query := "Здрав"

    words, err := SearchWords(ctx, userID, query)
    require.NoError(t, err)
    assert.NotEmpty(t, words)
}

func TestCalculateMastery(t *testing.T) {
    // 習得度計算のテスト
    reviewCount := 5
    averageScore := 85

    mastery := CalculateMastery(reviewCount, averageScore)
    assert.GreaterOrEqual(t, mastery, 0)
    assert.LessOrEqual(t, mastery, 100)
}
```

### Step 2: 実装

- テストが通るように実装
- コードコメントは日本語で
- 型安全性を最優先
- エラーハンドリングを必ず含める

#### 実装ファイル構造

```
backend/
├── internal/
│   ├── service/
│   │   └── vocabulary/
│   │       ├── service.go           # 単語帳サービス
│   │       ├── extractor.go         # 単語抽出
│   │       └── service_test.go
│   └── repository/
│       ├── word.go                   # 単語DB操作
│       └── word_test.go
└── pkg/
    └── vocabulary/
        ├── extractor.go              # 単語抽出ロジック
        └── extractor_test.go
```

#### 主要な実装ポイント

1. **単語抽出**
   ```go
   // pkg/vocabulary/extractor.go
   func ExtractWords(text string, language string) []string {
       // 1. テキストを単語に分割
       // 2. ストップワード除去
       // 3. 正規化（小文字化など）
       // 4. 重複除去
       // 5. 返却
   }
   ```

2. **単語帳サービス**
   ```go
   // internal/service/vocabulary/service.go
   func (s *VocabularyService) AutoCollectWords(ctx context.Context, userID string, bookID string, pageNumber int) error {
       // 1. ページのOCR結果取得
       // 2. 単語抽出
       // 3. 既存単語チェック
       // 4. 新規単語をDBに追加
   }

   func (s *VocabularyService) GetWords(ctx context.Context, userID string, filter *WordFilter) ([]*Word, error) {
       // 1. フィルタ条件で単語取得
       // 2. ソート
       // 3. 返却
   }
   ```

### Step 3: リファクタリング

- DRY原則の適用
- パフォーマンス最適化（インデックス最適化）
- コードの可読性向上

### Step 4: ドキュメント

- README.md への機能説明追加
- APIドキュメント
- 単語帳の使用方法

#### APIエンドポイント

```
GET  /api/v1/vocabulary/words
POST /api/v1/vocabulary/words
PUT  /api/v1/vocabulary/words/{word_id}
DELETE /api/v1/vocabulary/words/{word_id}
GET  /api/v1/vocabulary/words/{word_id}
POST /api/v1/vocabulary/auto-collect
```

## 制約事項

- 既存の `backend/internal/models/` は変更しない（新規追加のみ）
- `backend/internal/service/vocabulary/` 配下のみ編集可能
- 依存関係の追加は `go.mod` のみ

## 完了条件

- [ ] すべてのテストが通る
- [ ] lintエラーがない
- [ ] タイプエラーがない
- [ ] ドキュメントが更新されている
- [ ] 単語自動収集の動作確認
- [ ] 単語帳表示の動作確認

## 追加のテスト要件

### セキュリティテスト
- [ ] ユーザー認証の動作確認
- [ ] 単語データのプライバシー保護

### パフォーマンステスト
- [ ] 単語検索時間（100ms以内）
- [ ] 単語帳表示時間（500ms以内）
- [ ] 大量単語（1000語以上）での動作確認

### E2Eテスト
- [ ] 単語の自動収集
- [ ] 単語帳の表示
- [ ] 単語の追加・編集・削除
