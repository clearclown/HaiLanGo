# 機能実装: 書籍アップロード

## 要件

### 機能要件

#### 対応フォーマット
- **PDF**: メイン対応フォーマット
- **画像**: PNG, JPG, HEIC（HEICはPNGに変換）
- **連続アップロード**: 複数ファイルの一括アップロード対応

#### アップロード機能
1. **ファイル選択**
   - ドラッグ&ドロップ対応
   - ファイル選択ダイアログ
   - 複数ファイル選択可能

2. **ファイル検証**
   - ファイルサイズ制限：100MB/ファイル
   - ファイル形式チェック
   - ウイルススキャン（オプション）

3. **アップロード処理**
   - チャンクアップロード（大容量ファイル対応）
   - 進捗表示（リアルタイム）
   - エラーハンドリング（リトライ機能）

4. **書籍メタデータ**
   - タイトル（必須）
   - 学習先言語（必須）
   - 母国語（必須）
   - 参照言語（オプション）
   - 表紙画像（オプション）

#### ストレージ
- アップロードファイルはS3互換ストレージに保存
- ユーザーごとにディレクトリ分離
- E2E暗号化（オプション）

### 非機能要件

- **パフォーマンス**:
  - ファイルアップロード: 10MB/s以上
  - 進捗更新: 100ms間隔
  - 同時アップロード: 5ファイルまで

- **セキュリティ**:
  - ファイルタイプ検証（MIMEタイプ）
  - ファイルサイズ制限
  - ユーザー認証必須
  - ストレージへのアクセス制御

- **拡張性**:
  - 将来的にクラウドストレージ（AWS S3, GCS）対応
  - CDN統合の拡張性

- **エラーハンドリング**:
  - ネットワークエラー時のリトライ
  - ファイル破損の検出
  - ユーザーフレンドリーなエラーメッセージ

## 実装指示

### Step 1: テスト設計

以下の順でテストを作成：

1. **ユニットテスト（関数/メソッドレベル）**
   - ファイル形式検証
   - ファイルサイズチェック
   - MIMEタイプ検証
   - HEIC→PNG変換
   - メタデータバリデーション

2. **統合テスト（モジュール間）**
   - ファイルアップロードフロー
   - ストレージ保存処理
   - チャンクアップロード
   - 進捗更新の動作

3. **エッジケースのテスト**
   - 超大容量ファイル（制限超過）
   - 不正なファイル形式
   - ネットワーク切断時のリトライ
   - 同時アップロードの競合

テストファイルは `backend/internal/api/upload/upload_test.go` および `backend/internal/service/upload_test.go` に配置。

テストは **実装前に実行してすべて失敗すること** を確認。

#### テスト例（Go）

```go
// backend/internal/service/upload_test.go
package service

import (
    "testing"
    "bytes"
    "mime/multipart"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
)

func TestValidateFileType(t *testing.T) {
    // PDFファイル
    assert.True(t, ValidateFileType("application/pdf", "test.pdf"))

    // PNGファイル
    assert.True(t, ValidateFileType("image/png", "test.png"))

    // 不正なファイル
    assert.False(t, ValidateFileType("application/zip", "test.zip"))
}

func TestValidateFileSize(t *testing.T) {
    // 正常サイズ（10MB）
    assert.True(t, ValidateFileSize(10*1024*1024))

    // 制限超過（150MB）
    assert.False(t, ValidateFileSize(150*1024*1024))
}

func TestConvertHEICToPNG(t *testing.T) {
    // HEICファイルの変換テスト
    // ...
}

func TestUploadFile(t *testing.T) {
    // ファイルアップロードのテスト
    // モックストレージを使用
    // ...
}
```

### Step 2: 実装

- テストが通るように実装
- コードコメントは日本語で
- 型安全性を最優先
- エラーハンドリングを必ず含める

#### 実装ファイル構造

```
backend/
├── internal/
│   ├── api/
│   │   └── upload/
│   │       ├── handler.go          # HTTPハンドラー
│   │       └── handler_test.go
│   ├── service/
│   │   ├── upload.go               # アップロードビジネスロジック
│   │   └── upload_test.go
│   └── repository/
│       ├── book.go                 # 書籍DB操作
│       └── book_test.go
├── pkg/
│   ├── storage/
│   │   ├── storage.go              # ストレージ操作
│   │   └── storage_test.go
│   └── file/
│       ├── validator.go            # ファイル検証
│       └── validator_test.go
```

#### 主要な実装ポイント

1. **ファイル検証**
   ```go
   // pkg/file/validator.go
   func ValidateFile(file *multipart.FileHeader) error {
       // ファイルタイプ検証
       // ファイルサイズ検証
       // MIMEタイプ検証
   }
   ```

2. **ファイルアップロード**
   ```go
   // internal/service/upload.go
   func (s *UploadService) UploadBook(userID string, files []*multipart.FileHeader, metadata BookMetadata) (*Book, error) {
       // 1. ファイル検証
       // 2. ストレージに保存
       // 3. DBにメタデータ保存
       // 4. OCR処理をキューに追加（別feature）
   }
   ```

3. **チャンクアップロード**
   ```go
   // internal/service/upload.go
   func (s *UploadService) UploadChunk(userID string, bookID string, chunkNumber int, data []byte) error {
       // チャンクのアップロード
       // 最終チャンクでファイル結合
   }
   ```

### Step 3: リファクタリング

- DRY原則の適用
- パフォーマンス最適化（並列アップロード）
- コードの可読性向上

### Step 4: ドキュメント

- README.md への機能説明追加
- APIドキュメント
- 使用例

#### APIエンドポイント

```
POST /api/v1/books/upload
POST /api/v1/books/{book_id}/chunk
GET  /api/v1/books/{book_id}/upload-status
```

## 制約事項

- 既存の `backend/internal/models/book.go` は変更しない（新規追加のみ）
- `backend/internal/api/upload/` 配下のみ編集可能
- 依存関係の追加は `go.mod` のみ

## 完了条件

- [ ] すべてのテストが通る（Vitest + Playwright）
- [ ] BiomeJSエラーがない
- [ ] タイプエラーがない
- [ ] GitHub CIが通る
- [ ] ドキュメントが更新されている
- [ ] ファイルサイズ制限の動作確認
- [ ] 進捗表示の動作確認

## 追加のテスト要件

### セキュリティテスト
- [ ] ファイルタイプ検証の動作確認
- [ ] ファイルサイズ制限の動作確認
- [ ] 不正ファイルのアップロード防止

### パフォーマンステスト
- [ ] 大容量ファイル（50MB）のアップロード
- [ ] 複数ファイルの同時アップロード
- [ ] チャンクアップロードの効率性

### E2Eテスト
- [ ] ブラウザでのファイルアップロード
- [ ] ドラッグ&ドロップの動作確認
- [ ] 進捗表示の動作確認
