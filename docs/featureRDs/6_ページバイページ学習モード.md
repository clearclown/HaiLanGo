# 機能実装: ページバイページ学習モード

## 要件

### 機能要件

#### 学習モード
1. **ページ表示**
   - 1ページずつ表示
   - ページ画像の拡大・縮小
   - 前後のページへのナビゲーション

2. **音声機能**
   - TTS読み上げ（学習先言語）
   - 速度調整（0.5x〜2.0x）
   - リピート機能
   - 一時停止・再開

3. **フレーズ練習**
   - フレーズのリピート練習
   - ロールプレイ形式の会話練習
   - 発音チェック（STT連携）

4. **学習進捗**
   - ページ完了マーク
   - 進捗バーの更新
   - 学習履歴の記録

#### インタラクション
- ページタップで音声再生
- スワイプでページ遷移
- ボタン操作（再生、一時停止、次へ、前へ）

### 非機能要件

- **パフォーマンス**:
  - ページ表示: 500ms以内
  - 音声再生開始: 1秒以内
  - スムーズなページ遷移（60fps）

- **セキュリティ**:
  - ユーザー認証必須
  - 書籍データのアクセス制御

- **拡張性**:
  - 将来的な学習モード追加への対応
  - カスタマイズ可能なUI

- **エラーハンドリング**:
  - ネットワークエラー時のオフライン対応
  - 音声再生エラーの処理
  - ユーザーフレンドリーなエラーメッセージ

## 実装指示

### Step 1: テスト設計

以下の順でテストを作成：

1. **ユニットテスト（関数/メソッドレベル）**
   - ページナビゲーション
   - 進捗更新ロジック
   - 音声再生制御
   - 学習履歴の記録

2. **統合テスト（モジュール間）**
   - ページ表示から学習完了まで
   - 音声再生の動作
   - 進捗更新の動作
   - 学習履歴の保存

3. **エッジケースのテスト**
   - 最初のページ
   - 最後のページ
   - 存在しないページ
   - ネットワーク切断時
   - 音声再生エラー

テストファイルは以下の場所に配置：
- **フロントエンド**: `frontend/web/components/learning/*.test.tsx` (Vitest単体・統合テスト)
- **フロントエンドE2E**: `frontend/web/e2e/page-learning.spec.ts` (Playwright E2Eテスト)
- **バックエンド**: `backend/internal/api/learning/` (Goテスト)

テストは **実装前に実行してすべて失敗すること** を確認。

#### テスト例（Vitest - 単体・統合テスト）

```typescript
// frontend/web/components/learning/PageLearning.test.tsx
import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { PageLearning } from './PageLearning';

describe('PageLearning', () => {
  it('should render page content', () => {
    render(<PageLearning bookId="test-book" pageNumber={1} />);
    expect(screen.getByText('ページ 1')).toBeInTheDocument();
  });

  it('should navigate to next page', async () => {
    const { getByText } = render(<PageLearning bookId="test-book" pageNumber={1} />);
    fireEvent.click(getByText('次へ'));
    await waitFor(() => {
      expect(screen.getByText('ページ 2')).toBeInTheDocument();
    });
  });

  it('should play audio on tap', async () => {
    const mockPlay = vi.fn();
    global.Audio = vi.fn().mockImplementation(() => ({
      play: mockPlay,
      pause: vi.fn(),
    }));

    const { getByTestId } = render(<PageLearning bookId="test-book" pageNumber={1} />);
    const pageContent = getByTestId('page-content');
    fireEvent.click(pageContent);

    await waitFor(() => {
      expect(mockPlay).toHaveBeenCalled();
    });
  });

  it('should mark page as completed', async () => {
    const { getByText } = render(<PageLearning bookId="test-book" pageNumber={1} />);
    fireEvent.click(getByText('学習完了'));
    await waitFor(() => {
      expect(screen.getByText('完了済み')).toBeInTheDocument();
    });
  });
});
```

#### テスト例（Playwright - E2Eテスト）

```typescript
// frontend/web/e2e/page-learning.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Page Learning', () => {
  test.beforeEach(async ({ page }) => {
    // ログイン処理
    await page.goto('/login');
    await page.fill('[name="email"]', 'test@example.com');
    await page.fill('[name="password"]', 'password');
    await page.click('button[type="submit"]');
    await page.waitForURL('/');
  });

  test('should display page content', async ({ page }) => {
    await page.goto('/books/test-book/pages/1');
    await expect(page.locator('text=ページ 1')).toBeVisible();
  });

  test('should navigate to next page', async ({ page }) => {
    await page.goto('/books/test-book/pages/1');
    await page.click('text=次へ');
    await expect(page.locator('text=ページ 2')).toBeVisible();
  });

  test('should play audio when clicking page', async ({ page }) => {
    await page.goto('/books/test-book/pages/1');
    await page.click('[data-testid="page-content"]');
    // 音声再生の確認（実際の実装に応じて調整）
  });
});
```

#### テスト例（Go）

```go
// backend/internal/api/learning/handler_test.go
package learning

import (
    "testing"
    "net/http"
    "net/http/httptest"
    "github.com/stretchr/testify/assert"
)

func TestGetPage(t *testing.T) {
    // ページ取得のテスト
    req := httptest.NewRequest("GET", "/api/v1/books/test-book/pages/1", nil)
    w := httptest.NewRecorder()

    handler := GetPageHandler()
    handler.ServeHTTP(w, req)

    assert.Equal(t, http.StatusOK, w.Code)
}

func TestMarkPageCompleted(t *testing.T) {
    // ページ完了マークのテスト
    // ...
}
```

### Step 2: 実装

- テストが通るように実装
- コードコメントは日本語で
- 型安全性を最優先
- エラーハンドリングを必ず含める

#### 実装ファイル構造

```
frontend/web/
├── components/
│   └── learning/
│       ├── PageLearning.tsx        # メインコンポーネント
│       ├── PageNavigation.tsx       # ページナビゲーション
│       ├── AudioPlayer.tsx          # 音声プレイヤー
│       ├── ProgressBar.tsx          # 進捗バー
│       └── PageLearning.test.tsx
├── hooks/
│   ├── usePageLearning.ts          # 学習ロジック
│   └── useAudioPlayer.ts           # 音声再生ロジック
└── services/
    └── learningApi.ts               # API呼び出し

backend/
├── internal/
│   ├── api/
│   │   └── learning/
│   │       ├── handler.go           # HTTPハンドラー
│   │       └── handler_test.go
│   └── service/
│       └── learning/
│           ├── service.go           # 学習サービス
│           └── service_test.go
```

#### 主要な実装ポイント

1. **ページ学習コンポーネント**
   ```typescript
   // frontend/web/components/learning/PageLearning.tsx
   export const PageLearning: React.FC<Props> = ({ bookId, pageNumber }) => {
     const { page, loading, error } = usePage(bookId, pageNumber);
     const { playAudio, pauseAudio } = useAudioPlayer();
     const { markCompleted } = usePageLearning();

     // ページ表示
     // 音声再生
     // 進捗更新
   };
   ```

2. **学習サービス**
   ```go
   // backend/internal/service/learning/service.go
   func (s *LearningService) GetPage(ctx context.Context, bookID string, pageNumber int) (*Page, error) {
       // ページデータ取得
       // OCR結果取得
       // 音声URL取得
   }

   func (s *LearningService) MarkPageCompleted(ctx context.Context, userID string, bookID string, pageNumber int) error {
       // 学習履歴更新
       // 進捗更新
   }
   ```

### Step 3: リファクタリング

- DRY原則の適用
- パフォーマンス最適化（画像の遅延読み込み）
- コードの可読性向上

### Step 4: ドキュメント

- README.md への機能説明追加
- APIドキュメント
- UIコンポーネントの使用方法

#### APIエンドポイント

```
GET  /api/v1/books/{book_id}/pages/{page_number}
POST /api/v1/books/{book_id}/pages/{page_number}/complete
GET  /api/v1/books/{book_id}/progress
```

## 制約事項

- 既存の `frontend/web/components/` は変更しない（新規追加のみ）
- `frontend/web/components/learning/` 配下のみ編集可能
- 依存関係の追加は `package.json` のみ

## 完了条件

- [ ] すべてのテストが通る（Vitest + Playwright）
- [ ] BiomeJSエラーがない
- [ ] タイプエラーがない
- [ ] GitHub CIが通る
- [ ] ドキュメントが更新されている
- [ ] ページ遷移の動作確認
- [ ] 音声再生の動作確認

## 追加のテスト要件

### セキュリティテスト
- [ ] ユーザー認証の動作確認
- [ ] 書籍データのアクセス制御

### パフォーマンステスト
- [ ] ページ表示時間（500ms以内）
- [ ] 音声再生開始時間（1秒以内）
- [ ] スムーズなページ遷移（60fps）

### E2Eテスト
- [ ] ブラウザでのページ学習
- [ ] 音声再生の動作確認
- [ ] 進捗更新の動作確認
